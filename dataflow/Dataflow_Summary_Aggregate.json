{
	"name": "Dataflow_Summary_Aggregate",
	"properties": {
		"description": "Aggregate payroll data from 2020 and 2021, calculate total compensation, and output to SQL DB and Data Lake",
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_NYC_Payroll_Data_2020",
						"type": "DatasetReference"
					},
					"name": "source2020",
					"description": "2020 payroll data from SQL DB"
				},
				{
					"dataset": {
						"referenceName": "ds_NYC_Payroll_Data_2021",
						"type": "DatasetReference"
					},
					"name": "source2021",
					"description": "2021 payroll data from SQL DB"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_NYC_Payroll_Summary",
						"type": "DatasetReference"
					},
					"name": "sinkSQL",
					"description": "Output to SQL Database summary table"
				},
				{
					"dataset": {
						"referenceName": "ds_NYC_Payroll_Summary_DataLake",
						"type": "DatasetReference"
					},
					"name": "sinkDataLake",
					"description": "Output to Data Lake staging directory"
				}
			],
			"transformations": [
				{
					"name": "union1",
					"description": "Combine 2020 and 2021 data"
				},
				{
					"name": "derivedColumn1",
					"description": "Calculate TotalPaid"
				},
				{
					"name": "aggregate1",
					"description": "Aggregate by Agency and Fiscal Year"
				}
			],
			"script": "source(output(\n\t\tFiscalYear as integer,\n\t\tPayrollNumber as integer,\n\t\tAgencyID as string,\n\t\tAgencyName as string,\n\t\tEmployeeID as string,\n\t\tLastName as string,\n\t\tFirstName as string,\n\t\tAgencyStartDate as date,\n\t\tWorkLocationBorough as string,\n\t\tTitleCode as string,\n\t\tTitleDescription as string,\n\t\tLeaveStatusasofJune30 as string,\n\t\tBaseSalary as double,\n\t\tPayBasis as string,\n\t\tRegularHours as double,\n\t\tRegularGrossPaid as double,\n\t\tOTHours as double,\n\t\tTotalOTPaid as double,\n\t\tTotalOtherPay as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> source2020\nsource(output(\n\t\tFiscalYear as integer,\n\t\tPayrollNumber as integer,\n\t\tAgencyID as string,\n\t\tAgencyName as string,\n\t\tEmployeeID as string,\n\t\tLastName as string,\n\t\tFirstName as string,\n\t\tAgencyStartDate as date,\n\t\tWorkLocationBorough as string,\n\t\tTitleCode as string,\n\t\tTitleDescription as string,\n\t\tLeaveStatusasofJune30 as string,\n\t\tBaseSalary as double,\n\t\tPayBasis as string,\n\t\tRegularHours as double,\n\t\tRegularGrossPaid as double,\n\t\tOTHours as double,\n\t\tTotalOTPaid as double,\n\t\tTotalOtherPay as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> source2021\nsource2020, source2021 union(byName: true)~> union1\nunion1 derive(TotalPaid = RegularGrossPaid + TotalOTPaid + TotalOtherPay) ~> derivedColumn1\nderivedColumn1 aggregate(groupBy(AgencyName,\n\t\tFiscalYear),\n\tTotalPaid = sum(TotalPaid)) ~> aggregate1\naggregate1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tFiscalYear as integer,\n\t\tAgencyName as string,\n\t\tTotalPaid as double\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\trecreate:true,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> sinkSQL\naggregate1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\ttruncate: true,\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> sinkDataLake"
		}
	}
}